"use strict";var Module=angular.module("datePicker",[]);Module.constant("datePickerConfig",{template:"templates/datepicker.html",view:"month",views:["year","month","date","hours","minutes"],momentNames:{year:"year",month:"month",date:"day",hours:"hours",minutes:"minutes"},viewConfig:{year:["years","isSameYear"],month:["months","isSameMonth"],hours:["hours","isSameHour"],minutes:["minutes","isSameMinutes"]},step:5,firstDay:0}),Module.filter("mFormat",function(){return function(e,t,a){return moment.isMoment(e)?a?moment.tz(e,a).format(t):e.format(t):moment(e).format(t)}}),Module.directive("datePicker",["datePickerConfig","datePickerUtils",function(e,t){return{require:"?ngModel",template:'<div ng-include="template"></div>',scope:{model:"=datePicker",after:"=?",before:"=?"},link:function(a,i,n,s){function r(){a.views=e.views.concat(),a.view=n.view||e.view,a.views=a.views.slice(a.views.indexOf(n.maxView||"year"),a.views.indexOf(n.minView||"minutes")+1),1!==a.views.length&&a.views.indexOf(a.view)!==-1||(a.view=a.views[0])}function o(e){return t.getDate(a,n,e)}function m(e){e&&(a.model=e,s&&s.$setViewValue(e)),a.$emit("setDate",a.model,a.view),a.callbackOnSetDate&&a.callbackOnSetDate(n.datePicker,a.date)}function u(){var e=a.view;t.setParams(D,O),a.model&&!v&&(a.date=g(a.model),v=!1);var i=a.date;switch(e){case"year":a.years=t.getVisibleYears(i);break;case"month":a.months=t.getVisibleMonths(i);break;case"date":a.weekdays=a.weekdays||t.getDaysOfWeek(),a.weeks=t.getVisibleWeeks(i);break;case"hours":a.hours=t.getVisibleHours(i);break;case"minutes":a.minutes=t.getVisibleMinutes(i,y)}d()}function c(){return"date"!==a.view?a.view:a.date?a.date.month():null}function d(){var i,n,s=a.view,r=a.date,o=[],m="";if(t.setParams(D,O),"date"===s){var u,c=a.weeks;for(i=0;i<c.length;i++)for(u=c[i],o.push([]),n=0;n<u.length;n++)m="",t.isSameDay(r,u[n])&&(m+="active"),h(u[n],s)&&(m+=" now"),u[n].month()===r.month()&&l(u[n])||(m+=" disabled"),o[i].push(m)}else{var d=e.viewConfig[s],w=a[d[0]],f=d[1];for(i=0;i<w.length;i++)m="",t[f](r,w[i])&&(m+="active"),h(w[i],s)&&(m+=" now"),l(w[i])||(m+=" disabled"),o.push(m)}a.classes=o}function l(e){var t=!0;return b&&b.isAfter(e)&&(t=w(b,e)),V&&V.isBefore(e)&&(t&=w(V,e)),t}function w(t,i){return!!t.isSame(i,e.momentNames[a.view])}function f(e){return b&&b.isAfter(e)?b:V&&V.isBefore(e)?V:e}function h(e,t){var a=!0;switch(t){case"minutes":a&=~~(M.minutes()/y)==~~(e.minutes()/y);case"hours":a&=M.hours()===e.hours();case"date":a&=M.date()===e.date();case"month":a&=M.month()===e.month();case"year":a&=M.year()===e.year()}return a}var v=!1,D=a.tz=n.timezone,g=t.createMoment,k=t.eventIsForPicker,y=parseInt(n.step||e.step,10),p=!!n.partial,b=o("minDate"),V=o("maxDate"),x=i[0].id,M=a.now=g(),P=a.date=g(a.model||M),C="true"===n.autoClose,O=n.firstDay&&n.firstDay>=0&&n.firstDay<=6?parseInt(n.firstDay,10):e.firstDay;t.setParams(D,O),a.model||P.minute(Math.ceil(P.minute()/y)*y).second(0),a.template=n.template||e.template,a.watchDirectChanges=void 0!==n.watchDirectChanges,a.callbackOnSetDate=n.dateChange?t.findFunction(a,n.dateChange):void 0,r(),a.setView=function(e){a.views.indexOf(e)!==-1&&(a.view=e)},a.selectDate=function(e){if(n.disabled)return!1;if(w(a.date,e)&&(e=a.date),!(e=f(e)))return!1;a.date=e;var t=a.views[a.views.indexOf(a.view)+1];(!t||p||a.model)&&m(e),t?a.setView(t):C?(i.addClass("hidden"),a.$emit("hidePicker")):d()},a.$watch(c,u),a.watchDirectChanges&&a.$watch("model",function(){v=!1,u()}),a.next=function(e){var t=moment(a.date);switch(e=e||1,a.view){case"year":case"month":t.year(t.year()+e);break;case"date":t.month(t.month()+e);break;case"hours":case"minutes":t.hours(t.hours()+e)}(t=f(t))&&(a.date=t,m(t),v=!0,u())},a.prev=function(e){return a.next(-e||-1)},x&&a.$on("pickerUpdate",function(e,t,a){if(k(t,x)){var i=!1,s=!1;angular.isDefined(a.minDate)&&(b=!!a.minDate&&a.minDate,s=!0),angular.isDefined(a.maxDate)&&(V=!!a.maxDate&&a.maxDate,s=!0),angular.isDefined(a.minView)&&(n.minView=a.minView,i=!0),angular.isDefined(a.maxView)&&(n.maxView=a.maxView,i=!0),n.view=a.view||n.view,i&&r(),s&&u()}})}}}]);